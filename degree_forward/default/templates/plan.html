{% load array_access %}
<!DOCTYPE html>
<html lang="en" style="min-height: 100%">
<head>
    <meta charset="UTF-8">
    <title>Degree Forward</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" >
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</head>
<body style="min-height: 100%">
    <div class="container-fluid col-xs-9" style="background-color: lightgrey; padding-top: 20px; padding-bottom: 20px; min-height: 100%">
        <div class="container-fluid" style="margin-bottom:20px">
            {{ plan }} - {{ credits }} credits
        </div>
        <div class="container-fluid">
            {% for list in classList %}
            <div class="container-fluid" style="outline: 1px solid grey; margin-bottom: 10px" id="{{ forloop.counter }}">
                <div class = "container col-xs-2" style="margin-top: 10px; margin-bottom: 10px">
                    {% with forloop.counter as x %}
                    Semester {{ x }} <br>
                    Credits: <div id="{{ x }}credits" style="display: inline">{{ semCredits|lookup:x }}</div>
                    <input type="hidden" id="{{ x }}-crs" value="{{ semCredits|lookup:x }}">
                    {% endwith %}
                </div>
                {% for class in list %}
                <div class="container col-xs-1 {{ forloop.parentloop.counter }}class" style="margin-top: 10px; margin-bottom: 10px; margin-right: 30px;" id="{{ class.code }}">
                    <button class="container-fluid" style="outline: 1px solid black; width: 65px" onclick="edit('{{ class.code }}')" id="{{ class.code }}inner">
                        {{ class.code }} {{ class.credits }} cr
                        <input type="hidden" id="{{ class.code }}-sem" value="{{ forloop.parentloop.counter }}">
                        <input type="hidden" id="{{ class.code }}-prereqs" value="{{ class.prereqs }}">
                    </button>
                </div>
                {% endfor %}
                <div class="container col-xs-1" style="margin-top: 10px; margin-bottom: 10px" id="add{{ forloop.counter }}">
                    <button class="container-fluid" style="outline: 1px solid black; width: 60px; " onclick="addClass('{{ forloop.counter }}')">
                        Add Class
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="container-fluid col-xs-3 fill" style="background-color: grey; padding-top: 30px; min-height: 100%">
        <form action="/plan/" method="POST">{% csrf_token %}
            <select name="plan">
                {% for plan in allplans %}
                <option value="{{ plan.Major }}">{{ plan.Major }}</option>
                {% endfor %}
            </select>
            <input type="submit" value="Generate Plan">
        </form>
        <br>

        <!--
        <div class="container-fluid" style="margin-bottom: 30px; border-bottom: 10px">
            <div class="container-fluid">
                <button class="btn btn-primary" style="margin-bottom: 10px" onclick="addStuff()">Add a Course</button>
            </div>
            <div class="container-fluid" style="outline: 1px solid black; background-color: white; margin-bottom: 5px">
                <div class="col-xs-4">Pancakes</div>
                <div class="col-xs-6 col-xs-offset-2"><button onclick="panic()">Auto Add</button><br><button onclick="panic()">Delete</button></div>
            </div>
        </div>
        -->
        <div class="container-fluid" style="outline: 1px solid black; margin-bottom: 30px; background-color: lightblue">
            Completed Courses:
            <div class = "container-fluid" id="completed">

            </div>
        </div>
    </div>

    <script>
        change("plan");
        change("semester");

        function panic(){
            alert("Feature Unimplemented");
        }

        function edit(classcode, semester){
            var x = window.prompt("Please Type the command you wish to perform (Choices are Move/Check/Uncheck/Delete)");
            if(x == null) return;
            if(x.toLowerCase() == 'move'){
                var destSem = window.prompt("Which semester would you like to move this class to?")
                moveClass(classcode, destSem);
            }
            else if(x.toLowerCase() == 'check'){
                 if(document.getElementById(classcode + "inner").style.backgroundColor == "") {
                      var info = document.getElementById(classcode + '-info').value;
                      var infos = info.split(',');
                      var prereqs = infos[1].split(';');
                      if (prereqs[0] != 'NONE') {
                          for (var i = 0; i < prereqs.length; i++) {
                              pr = prereqs[i];
                              if (!(document.getElementById("completed").innerHTML.contains(pr))) {
                                  alert("Unable to move class due to dependency problems. You can't complete "+classcode+" without completing "+pr);
                                  return;
                              }
                          }
                      }
                      document.getElementById(classcode + "inner").style.backgroundColor = "lightgreen";
                      var content = document.getElementById(classcode + "inner").innerHTML;
                      document.getElementById("completed").innerHTML += '<p>'+content+'</p>';
                      changeCredits(classcode, 0);
                 }
            }
            else if(x.toLowerCase() == 'uncheck') {
                if(document.getElementById(classcode + "inner").style.backgroundColor == "lightgreen") {
                    document.getElementById(classcode + "inner").style.backgroundColor = "";
                    var content = document.getElementById(classcode + "inner").innerHTML;
                    var complete = document.getElementById("completed").innerHTML;
                    complete2 = complete.replace('<p>'+content+'</p>', "");
                    document.getElementById("completed").innerHTML = complete2;
                    changeCredits(classcode, 1)
                }
            }
            else if(x.toLowerCase() == 'delete'){
                if(document.getElementById(classcode + "inner").style.backgroundColor == "") changeCredits(classcode, 0);
                var div = document.getElementById(classcode);
                div.parentNode.removeChild(div);
            }
            else{
                alert("Invalid Input. Try Again.");
                edit(classcode);
            }
        }

        function changeCredits(cc, add){
            var classStr = document.getElementById(cc + '-info').value;
            var infos = classStr.split(',');
            var crs = parseInt(infos[0]);
            var semester = document.getElementById(cc+'-sem').value;
            var semCrs = parseInt(document.getElementById(semester+'credits').innerHTML);
            var newCrs = 0;

            if(add) newCrs = semCrs + crs;
            else newCrs = semCrs - crs;

            document.getElementById(semester+'credits').innerHTML = newCrs;
        }

        function moveClass(cc, dest) {
            var info = document.getElementById(cc + '-info').value;
            var infos = info.split(',');
            var prereqs = infos[1].split(';');
            if (prereqs[0] != 'NONE') {
                for (var i = 0; i < prereqs.length; i++) {
                    var pr = prereqs[i].toUpperCase();
                    var prsem = document.getElementById(pr + '-sem').value;
                    if (dest >= prsem && prsem != 0) {
                        alert("Unable to move class due to dependency problems. You must have " + pr + " before you can take " + cc);
                        return;
                    }
                }
            }
            var j = dest;
            while (dest > 0) {
                var a = document.getElementsByClassName(j + 'class');
                for (var k = 0; k < a.length; k++) {
                    var curClass = a[k].id;

                    var curInfos = document.getElementById(curClass + '-info').value.split(',');
                    var curPreqs = curInfos[1].split(';');
                    if (curPreqs[0] != 'NONE') {
                        for (var i = 0; i < prereqs.length; i++) {
                            var cpr = curPreqs[i].toUpperCase();
                            var cprsem = document.getElementById(curClass + '-sem').value;
                            if (dest >= cprsem && cprsem != 0) {
                                alert("Unable to move class due to dependency problems. "+ cc +" must not occur before "+ cpr);
                                return;
                            }
                        }
                    }
                }
                j--;
            }
                changeCredits(cc, 0);
                var div = document.getElementById(cc);
                div.parentNode.removeChild(div);
                var adddiv = document.getElementById("add" + dest);
                adddiv.parentNode.removeChild(adddiv);
                var writestring = '<div class="container col-xs-1 ' + dest + 'class" style="margin-top: 10px; margin-bottom: 10px; margin-right: 30px;" id="' + cc + '">' +
                        '<button class="container-fluid" style="outline: 1px solid black; width: 65px" onclick="edit(\'' + cc + '\')" id="' + cc + 'inner">' +
                        cc + ' ' + infos[0] + ' cr' +
                        '<input type="hidden" id="' + cc + '-sem" value="' + dest + '">' +
                        '<input type="hidden" id="' + cc + '-prereqs" value="' + infos[1] + '">' +
                        '</button>' +
                        '</div>';
                document.getElementById(dest).innerHTML += writestring;
                changeCredits(cc, 1);
                document.getElementById(dest).innerHTML += '<div class="container col-xs-1" style="margin-top: 10px; margin-bottom: 10px" id="add' + dest + '">' +
                        '<button class="container-fluid" style="outline: 1px solid black; width: 60px" onclick="addClass(\'' + dest + '\')">' +
                        'Add Class' +
                        '</button>' +
                        '</div>';
        }

        function addStuff(){
            alert("I will add this in some amount of time.")
        }

        function addClass(dest) {
            var prompt = window.prompt("What class code are you wanting to add? (ex. MATH 165)");
            if (prompt != null) {
                var cc = prompt.toUpperCase();
                var info = document.getElementById(cc + '-info').value;
                if (document.getElementById(cc) == null) {
                    if (info.contains(',')) {
                        var infos = info.split(',');
                        var prereqs = infos[1].split(';');
                        if (prereqs[0] != 'NONE') {
                            for (var i = 0; i < prereqs.length; i++) {
                                var pr = prereqs[i].toUpperCase();
                                var prsem = document.getElementById(pr + '-sem').value()
                                if (dest <= prsem) {
                                    alert("Unable to add class due to dependency problems. You must have " + pr + " before you can take " + cc);
                                    return;
                                }
                            }
                        }
                        var div = document.getElementById("add" + dest);
                        div.parentNode.removeChild(div);
                        var writestring = '<div class="container col-xs-1 '+dest+'class" style="margin-top: 10px; margin-bottom: 10px; margin-right: 30px;" id="' + cc + '">' +
                                '<button class="container-fluid" style="outline: 1px solid black; margin-right:5px; width: 65px" onclick="edit(\'' + cc + '\')" id="' + cc + 'inner">' +
                                cc + ' ' + infos[0] + ' crs' +
                                '<input type="hidden" id="' + cc + '-sem" value="' + dest + '">' +
                                '<input type="hidden" id="' + cc + '-prereqs" value="' + infos[1] + '">' +
                                '</button>' +
                                '</div>';
                        document.getElementById(dest).innerHTML += writestring;
                        changeCredits(cc, 1);
                        document.getElementById(dest).innerHTML += '<div class="container col-xs-1" style="margin-top: 10px; margin-bottom: 10px" id="add' + dest + '">' +
                                '<button class="container-fluid" style="outline: 1px solid black; width: 60px;" onclick="addClass(\'' + dest + '\')">' +
                                'Add Class' +
                                '</button>' +
                                '</div>';
                    }
                    else {
                        alert("That class is not available");
                        return;
                    }
                }
                else {
                    alert("Course is already present");
                    return;
                }
            }
            else {
                return;
            }
        }


        function change(dropdown){
            $('#'+dropdown).on('click', 'li a', function(){
                $('#'+dropdown+"btn").html($(this).text()+' <span class="caret"></span>');
                $('#'+dropdown+"btn").val($(this).text());
            });
        }
    </script>
    <div class="hidden">
        {% for class in allclasses %}
        <input type="hidden" id="{{ class.code }}-info" value="{{ class.credits }},{{ class.prereqs }},{{ class.satisfies }}">
        {% endfor %}
    </div>
</body>
</html>